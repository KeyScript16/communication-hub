<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Group - Crescendo</title>
    <link rel="stylesheet" href="css.css">
</head>
<body>
    <div id="main-content" style="width: 400px;">
        <h1>Create a Group</h1>
        
        <label style="display:block; text-align:left; font-size:12px; color:#4ecca3;">GROUP NAME</label>
        <input type="text" id="group-name" placeholder="The Dev Squad...">

        <label style="display:block; text-align:left; font-size:12px; color:#4ecca3; margin-top:15px;">DESCRIPTION (OPTIONAL)</label>
        <input type="text" id="group-desc" placeholder="What's this group about?">

        <!-- FRIENDS LIST TO INVITE -->
        <div id="invite-section" style="margin-top:20px; text-align:left;">
            <h4 style="margin-bottom:10px;">Invite Friends:</h4>
            <div id="friends-checkbox-list" style="max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                Loading friends...
            </div>
        </div>

        <button onclick="createGroup()">Launch Group ðŸš€</button>
        <button onclick="window.location.href='dashboard.html'" style="background:none; color:#4ecca3;">Cancel</button>
    </div>

    <script>
    const BASE_URL = 'https://crescendo-chat.onrender.com';
    const user = JSON.parse(sessionStorage.getItem("currentUser") || "{}");
    if (!user.email) window.location.href = 'index.html';

    async function loadFriends() {
        const res = await fetch(`${BASE_URL}/get-data`);
        const allUsers = await res.json();
        // FIXED: Using case-insensitive find
        const me = allUsers.find(u => u.email.toLowerCase() === user.email.toLowerCase());
        const listDiv = document.getElementById('friends-checkbox-list');
        
        if (me && me.friends && me.friends.length > 0) {
            listDiv.innerHTML = me.friends.map(f => `
                <div style="margin-bottom:5px;">
                    <input type="checkbox" name="friend" value="${f}" style="width:auto; margin-right:10px;">
                    <span>${f}</span>
                </div>`).join('');
        } else {
            listDiv.innerHTML = "Add friends first to invite them!";
        }
    }

    async function createGroup() {
        const name = document.getElementById('group-name').value;
        const desc = document.getElementById('group-desc').value;
        const selected = Array.from(document.querySelectorAll('input[name="friend"]:checked')).map(cb => cb.value);

        if (!name) return alert("Group name required!");

        const response = await fetch(`${BASE_URL}/create-new-group`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                groupName: name,
                description: desc,
                creator: user.email.toLowerCase(),
                invited: selected
            })
        });

        if (response.ok) {
            alert("Group Created!");
            window.location.href = 'dashboard.html';
        }
    }
    loadFriends();
</script>

</body>
</html>

