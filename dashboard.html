<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css.css">
    
    <!-- ONLY ONE EXTERNAL SCRIPT: Socket.io (which we know works now) -->
    <script src="https://cdn.socket.io"></script>

    <title>Dashboard</title>
    
    <style>
        /* Safe system fonts that don't need to be downloaded */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    </style>
</head>
<body style="background: #1a1a2e; color: white;">
    <div id="main-content" style="width: 450px; margin: 20px auto; text-align: center;">
        <h1>Dashboard</h1>
        <p>Welcome, <span id="display-name">Loading...</span></p>

        <div id="user-ui">
            <div id="friends-list" style="margin-top: 20px; text-align: left;"></div>
            
            <div id="clubs-container" style="max-width: 500px; margin: 20px auto;">
                <div id="pending-section" style="display:none; margin-bottom: 30px;">
                    <h3 style="color: #4ecca3;">Club Invites üì©</h3>
                    <div id="pending-list"></div>
                </div>
                <div id="active-section">
                    <h3 style="color: #4ecca3;">Your Clubs üöÄ</h3>
                    <div id="active-list">Waking up server...</div>
                </div>
            </div>

            <button onclick="addFriend()" style="margin-top: 20px; background: #4ecca3; color: #1a1a2e; width: 100%; padding: 10px; cursor: pointer; border:none;">Add New Friend</button>
            <button onclick="window.location.href='create-group.html'" style="margin-top: 10px; background: rgba(78, 204, 163, 0.2); border: 1px solid #4ecca3; color: #4ecca3; width: 100%; padding: 10px; cursor: pointer;">Create New Group</button>
        </div>

        <button onclick="logout()" style="margin-top: 20px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); width: 100%; padding: 10px; cursor: pointer;">Logout</button>
    </div>

    <script>
        const BASE_URL = 'https://crescendo-chat.onrender.com';
        const userData = sessionStorage.getItem("currentUser");
        if (!userData) window.location.href = 'index.html';
        const user = JSON.parse(userData);

        document.getElementById('display-name').innerText = user.username;

        let socket;
        try {
            socket = io(BASE_URL);
        } catch (e) { console.error("Socket error"); }

        async function init() {
            try {
                // Wake up Render server
                await fetch(`${BASE_URL}/get-data`);
                if (socket) {
                    socket.emit('go-online', { email: user.email.toLowerCase(), username: user.username });
                    loadMyGroups();
                }
            } catch(e) { console.log("Server waking up..."); }
        }

        if (socket) {
            socket.on('update-online-list', async (onlineEmails) => {
                const listDiv = document.getElementById('friends-list');
                const response = await fetch(`${BASE_URL}/get-data`);
                const allUsers = await response.json();
                const me = allUsers.find(u => u.email.toLowerCase() === user.email.toLowerCase());
                if (!me) return;
                listDiv.innerHTML = "<h3>Friends:</h3>"; 
                if (me.friends) {
                    me.friends.forEach(fEmail => {
                        const online = onlineEmails.map(e => e.toLowerCase()).includes(fEmail.toLowerCase());
                        listDiv.innerHTML += `<div style="margin:10px 0;">${fEmail} ${online ? '‚óè' : '‚óã'}</div>`;
                    });
                }
            });
        }

        async function loadMyGroups() {
            try {
                const response = await fetch(`${BASE_URL}/get-my-groups?email=${user.email.toLowerCase()}`);
                const { joined, pending } = await response.json();
                
                if (pending && pending.length > 0) {
                    document.getElementById('pending-section').style.display = "block";
                    document.getElementById('pending-list').innerHTML = pending.map(g => `<div>${g.group_name}</div>`).join('');
                }

                document.getElementById('active-list').innerHTML = (joined && joined.length > 0) ? joined.map(g => `<div>${g.group_name}</div>`).join('') : "No clubs joined yet.";
            } catch (err) { console.error(err); }
        }

        function logout() { sessionStorage.clear(); window.location.href = 'index.html'; }
        
        init();
    </script>
</body>
</html>
