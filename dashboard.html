<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css.css">
    <!-- FIXED: Rock-solid Socket.io link from CDNJS -->
    <script src="https://cdnjs.cloudflare.com"></script>
    <title>Dashboard</title>
</head>
<body style="background: #1a1a2e; color: white; font-family: sans-serif; text-align: center;">
    <div id="main-content" style="width: 450px; margin: 50px auto;">
        <h1>Dashboard</h1>
        <!-- This will be updated INSTANTLY by the script below -->
        <p>Welcome, <span id="display-name">Loading...</span></p>

        <div id="user-ui">
            <div id="friends-list" style="margin-top: 20px; text-align: left;"></div>
            <div id="active-list" style="margin-top: 10px; color: #4ecca3;">Waking up server...</div>
            <button onclick="addFriend()" style="margin-top: 20px; width: 100%; padding: 10px; cursor: pointer;">Add Friend</button>
        </div>
        <button onclick="sessionStorage.clear(); window.location.href='index.html'" style="margin-top: 20px; width: 100%; opacity: 0.6;">Logout</button>
    </div>

    <script>
        const BASE_URL = 'https://crescendo-chat.onrender.com';
        const userData = sessionStorage.getItem("currentUser");
        if (!userData) window.location.href = 'index.html';
        const user = JSON.parse(userData);

        // --- STEP 1: FIX THE "LOADING..." BUG INSTANTLY ---
        document.getElementById('display-name').innerText = user.username;

        // --- STEP 2: TRY TO CONNECT (IF IT FAILS, THE NAME STAYS) ---
        let socket;
        try {
            socket = io(BASE_URL);
        } catch (e) { console.error("Socket failed to load."); }

        async function init() {
            try {
                // Wake up Render (Free tier takes a while)
                await fetch(`${BASE_URL}/get-data`);
                if (socket) {
                    socket.emit('go-online', { email: user.email.toLowerCase(), username: user.username });
                    document.getElementById('active-list').innerText = "Server Online üöÄ";
                }
            } catch (e) { 
                document.getElementById('active-list').innerText = "Server waking up... try refreshing in 30s.";
            }
        }

        // --- STEP 3: HANDLE FRIENDS (IF SOCKET WORKS) ---
        if (socket) {
            socket.on('update-online-list', async (onlineEmails) => {
                const listDiv = document.getElementById('friends-list');
                try {
                    const res = await fetch(`${BASE_URL}/get-data`);
                    const allUsers = await res.json();
                    const me = allUsers.find(u => u.email.toLowerCase() === user.email.toLowerCase());
                    if (!me || !me.friends) return;

                    listDiv.innerHTML = "<h3>Friends:</h3>";
                    me.friends.forEach(fEmail => {
                        const online = onlineEmails.map(e => e.toLowerCase()).includes(fEmail.toLowerCase());
                        listDiv.innerHTML += `<div>${fEmail} ${online ? '‚óè' : '‚óã'}</div>`;
                    });
                } catch(err) { console.log("List update failed."); }
            });
        }

        init();
    </script>
</body>
</html>
