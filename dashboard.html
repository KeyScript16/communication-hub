<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Session</title>
    <link rel="stylesheet" href="css.css">
    <script src="https://cdn.socket.js/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div id="main-content" style="width: 500px; height: 80vh; display: flex; flex-direction: column;">
        <h1 id="chat-header">Chat</h1>
        <div id="message-history" style="flex-grow: 1; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;"></div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="chat-input" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
        <button onclick="goBack()" style="background: none; color: #4ecca3; margin-top: 10px;">Back to Dashboard</button>
    </div>

    <script>
        const BASE_URL = 'https://crescendo-chat.onrender.com';
        const socket = io(BASE_URL);
        const user = JSON.parse(sessionStorage.getItem("currentUser") || "{}");
        const params = new URLSearchParams(window.location.search);
        const friendEmail = params.get('with');

        if (!user.email || !friendEmail) window.location.href = 'index.html';
        document.getElementById('chat-header').innerText = "Chat with " + friendEmail;
        
        socket.emit('go-online', { email: user.email, username: user.username });

        socket.on('new-message', (data) => {
            if (data.fromEmail.toLowerCase() === friendEmail.toLowerCase()) {
                displayMessage(data.fromName, data.message);
            }
        });

        function sendMessage() {
            const input = document.getElementById('chat-input');
            if (input.value && friendEmail) {
                socket.emit('private-message', { 
                    to: friendEmail.toLowerCase(), 
                    message: input.value, 
                    fromName: user.username, 
                    fromEmail: user.email.toLowerCase() 
                });
                displayMessage("Me", input.value);
                input.value = "";
            }
        }

        function displayMessage(name, text) {
            const history = document.getElementById('message-history');
            const div = document.createElement('div');
            div.innerHTML = `<strong>${name}:</strong> ${text}`;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        function goBack() {
            socket.emit('leave-chat', friendEmail);
            window.location.href = 'dashboard.html';
        }

        socket.on('chat-ended-by-friend', () => {
            alert("Your friend left the chat.");
            window.location.href = 'dashboard.html';
        });

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
