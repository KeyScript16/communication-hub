<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css.css">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <title>Dashboard</title>
</head>
<body>
    <div id="main-content" style="width: 450px;">
        <h1>Dashboard</h1>
        <p>Welcome, <span id="display-name">Loading...</span></p>
        
        <div id="friends-list" style="margin-top: 20px; text-align: left;"></div>

        <button onclick="addFriend()" style="margin-top: 20px; background: #4ecca3; color: #1a1a2e;">Add New Friend</button>
        <button onclick="logout()" style="margin-top: 10px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);">Logout</button>
    </div>

    <script>
        const BASE_URL = 'https://crescendo-chat.onrender.com';
        const userData = sessionStorage.getItem("currentUser");
        if (!userData) window.location.href = 'index.html';
        const user = JSON.parse(userData);
        
        // Wake up logic
        async function init() {
    document.getElementById('display-name').innerText = user.username;
    try {
        await fetch(`${BASE_URL}/get-data`);
        console.log("Server Awake");
        // ADD THIS LINE to refresh the list immediately on load:
        socket.emit('go-online', user.email); 
    } catch(e) { console.log("Waking up..."); }

        const socket = io(BASE_URL); 
        socket.emit('go-online', user.email);

        socket.on('update-online-list', async (onlineEmails) => {
            const listDiv = document.getElementById('friends-list');
            listDiv.innerHTML = "<h3>Friends:</h3>"; 

            const response = await fetch(`${BASE_URL}/get-data`);
            const allUsers = await response.json();
            const me = allUsers.find(u => u.email.toLowerCase() === user.email.toLowerCase());

            if (me) {
                // Show incoming requests
                if (me.requests && me.requests.length > 0) {
                    let reqHtml = "<div style='background:rgba(78,204,163,0.1); padding:10px; border-radius:10px; margin-bottom:20px;'><h4>New Requests:</h4>";
                    me.requests.forEach(s => {
                        reqHtml += `<div style='display:flex; justify-content:space-between; margin-bottom:5px;'><span>${s}</span><button onclick="acceptFriend('${s}')">Accept</button></div>`;
                    });
                    listDiv.innerHTML = reqHtml + "</div>" + listDiv.innerHTML;
                }

                // Show friends
                (me.friends || []).forEach(f => {
                    const online = onlineEmails.includes(f);
                    const row = document.createElement('div');
                    row.style.margin = "10px 0";
                    row.innerHTML = `<span>${f} ${online ? '●' : '○'}</span> ${online ? `<button onclick="startChat('${f}')">Chat</button>` : ''}`;
                    listDiv.appendChild(row);
                });
            }
        });

        async function addFriend() {
            const target = prompt("Friend's email:");
            if (!target || target === user.email) return;

            const res = await fetch(`${BASE_URL}/get-data`);
            let users = await res.json();
            let friend = users.find(u => u.email === target);

            if (friend) {
                friend.requests = friend.requests || [];
                if (!friend.requests.includes(user.email)) {
                    friend.requests.push(user.email);
                    await fetch(`${BASE_URL}/save-data`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(users) 
                    });
                    alert("Request Sent!");
                }
            } else alert("User not found");
        }

        async function acceptFriend(sender) {
            const res = await fetch(`${BASE_URL}/get-data`);
            let users = await res.json();
            let me = users.find(u => u.email === user.email);
            let them = users.find(u => u.email.toLowerCase() === sender.toLowerCase());

            if(me && them) {
                me.friends = me.friends || []; 
                them.friends = them.friends || [];
                if(!me.friends.includes(sender)) me.friends.push(sender);
                if(!them.friends.includes(user.email)) them.friends.push(user.email);
                me.requests = me.requests.filter(r => r !== sender);

                await fetch(`${BASE_URL}/save-data`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(users) 
                });
                location.reload();
            }
        }

        function startChat(f) {
            socket.emit('request-chat', { to: f, fromName: user.username, fromEmail: user.email });
        }

        socket.on('chat-requested', (d) => {
            if(confirm(d.fromName + " wants to chat!")) {
                socket.emit('chat-response', { to: d.fromEmail, fromEmail: user.email, accepted: true });
                window.location.href = `chat.html?with=${d.fromEmail}`;
            }
        });

        socket.on('start-chat-confirmed', (d) => {
            if(d.accepted) window.location.href = `chat.html?with=${d.fromEmail}`;
        });

                function logout() { 
            sessionStorage.clear(); 
            window.location.href = 'index.html'; 
        }

        // Final call to start the app
        init();
    </script>
</body>
</html>





