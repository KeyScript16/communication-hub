<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css.css">
    
    <!-- FIXED: Use cdnjs to avoid the MIME/Syntax error you were seeing -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <link rel="icon" type="image/png" href="favicon-32x32.png?v=1">
    <title>Dashboard</title>
</head>
<body style="background:#1a1a2e; color:white; font-family:sans-serif; text-align:center;">
    <div id="main-content" style="width:450px; margin:50px auto;">
        <h1>Dashboard</h1>
        <p>Welcome, <span id="display-name" style="color:#4ecca3; font-weight:bold;">Loading...</span></p>

        <!-- ADMIN UI -->
        <div id="admin-ui" style="display:none; background:rgba(255,77,77,0.1); padding:20px; border-radius:10px; border:1px solid #ff4d4d; margin-bottom: 20px;">
            <h3 style="color:#ff4d4d; margin-top:0;">System Administration</h3>
            <button onclick="securePurge()" style="background:#ff4d4d; color:white; width:100%; padding:20px; font-weight:bold; cursor:pointer;">üî• RESET SYSTEM</button>
        </div>

        <!-- USER UI -->
        <div id="user-ui" style="display:none;">
            <!-- PENDING REQUESTS with ACCEPT & DECLINE -->
            <div id="requests-box" style="display:none; text-align:left; background:rgba(78, 204, 163, 0.1); padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #4ecca3;">
                <h3 style="color:#4ecca3; margin-top:0;">Friend Requests üì©</h3>
                <div id="requests-inner"></div>
            </div>

            <!-- FRIENDS -->
            <div style="text-align:left; margin-bottom:20px; background:rgba(255,255,255,0.05); padding:15px; border-radius:10px;">
                <h3 style="color:#4ecca3; margin-top:0;">Friends</h3>
                <div id="friends-inner">Loading...</div>
            </div>

            <!-- CLUBS -->
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom: 20px;">
                <h3 style="color:#4ecca3; margin-top:0;">Your Clubs üöÄ</h3>
                <div id="active-list">Connecting...</div>
            </div>

            <button onclick="addFriend()" style="width: 100%; padding: 12px; background: #4ecca3; color: #1a1a2e; font-weight: bold; border: none; border-radius: 5px; cursor: pointer;">Add New Friend</button>
            <button onclick="window.location.href='create-group.html'" style="margin-top: 10px; width: 100%; padding: 10px; background: rgba(78, 204, 163, 0.2); color: #4ecca3; border: 1px solid #4ecca3; border-radius: 5px; cursor: pointer;">Create New Group</button>
        </div>
        
        <button onclick="logout()" style="margin-top: 30px; width: 100%; padding: 10px; opacity: 0.4; cursor: pointer;">Logout</button>
    </div>

    <script>
        const BASE_URL = 'https://crescendo-chat.onrender.com';
        const user = JSON.parse(sessionStorage.getItem("currentUser") || "{}");
        if (!user.username) window.location.href = 'index.html';

        document.getElementById('display-name').innerText = user.username;
        const socket = (typeof io !== 'undefined') ? io(BASE_URL) : null;

        async function init() {
            const isAdm = user.isAdmin === true || String(user.isAdmin).toLowerCase() === "true";
            document.getElementById('admin-ui').style.display = isAdm ? "block" : "none";
            document.getElementById('user-ui').style.display = isAdm ? "none" : "block";

            if (!isAdm) {
                try {
                    await fetch(`${BASE_URL}/get-data`);
                    if (socket) {
                        socket.emit('go-online', { email: user.email.toLowerCase(), username: user.username });
                        socket.on('update-online-list', (list) => updateFriendsUI(list));
                    }
                    loadMyGroups();
                    updateFriendsUI([]); 
                } catch (e) { document.getElementById('active-list').innerText = "Server waking up..."; }
            }
        }

        async function updateFriendsUI(onlineList) {
            const res = await fetch(`${BASE_URL}/get-data`);
            const data = await res.json();
            const me = data.find(u => u.email.toLowerCase() === user.email.toLowerCase());
            if (!me) return;

            // 1. Handle Requests (Accept/Decline)
            const rBox = document.getElementById('requests-box');
            if (me.requests && me.requests.length > 0) {
                rBox.style.display = "block";
                document.getElementById('requests-inner').innerHTML = me.requests.map(r => `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                        <span style="font-size:12px;">${r}</span>
                        <div>
                            <button onclick="handleReq('${r}','accept')" style="background:#4ecca3; border:none; padding:4px 8px; cursor:pointer; border-radius:3px;">Accept</button>
                            <button onclick="handleReq('${r}','decline')" style="background:#ff4d4d; border:none; padding:4px 8px; cursor:pointer; color:white; border-radius:3px; margin-left:5px;">Decline</button>
                        </div>
                    </div>`).join('');
            } else { rBox.style.display = "none"; }

            // 2. Handle Friends + Online Dots
            const onlineLow = onlineList.map(e => e.toLowerCase());
            document.getElementById('friends-inner').innerHTML = (me.friends && me.friends.length > 0) 
                ? me.friends.map(f => {
                    const isOn = onlineLow.includes(f.toLowerCase());
                    return `
                        <div style="display:flex; justify-content:space-between; margin:10px 0; align-items:center;">
                            <span>${f} ${isOn ? '<span style="color:#4ecca3">‚óè</span>' : '‚óã'}</span>
                            ${isOn ? `<button onclick="window.location.href='chat.html?with=${f}'" style="padding:4px 8px; font-size:11px; cursor:pointer; background:#4ecca3; border:none; border-radius:3px; color:#1a1a2e; font-weight:bold;">Chat</button>` : ''}
                        </div>`;
                }).join('') : "No friends yet.";
        }

        async function handleReq(email, action) {
            const res = await fetch(`${BASE_URL}/get-data`);
            let users = await res.json();
            let me = users.find(u => u.email.toLowerCase() === user.email.toLowerCase());
            let sender = users.find(u => u.email.toLowerCase() === email.toLowerCase());
            
            if (me) {
                me.requests = (me.requests || []).filter(r => r.toLowerCase() !== email.toLowerCase());
                if (action === 'accept') {
                    me.friends = me.friends || [];
                    if (!me.friends.includes(email.toLowerCase())) me.friends.push(email.toLowerCase());
                    if (sender) {
                        sender.friends = sender.friends || [];
                        if (!sender.friends.includes(user.email.toLowerCase())) sender.friends.push(user.email.toLowerCase());
                    }
                }
                await fetch(`${BASE_URL}/save-data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(users) });
                location.reload();
            }
        }

        async function addFriend() {
            const target = prompt("Email:").toLowerCase().trim();
            if (!target || target === user.email.toLowerCase()) return;
            const res = await fetch(`${BASE_URL}/get-data`);
            let users = await res.json();
            let friend = users.find(u => u.email.toLowerCase() === target);
            if (friend) {
                friend.requests = friend.requests || [];
                if (!friend.requests.includes(user.email.toLowerCase())) {
                    friend.requests.push(user.email.toLowerCase());
                    await fetch(`${BASE_URL}/save-data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(users) });
                    alert("Request Sent!");
                } else { alert("Already pending!"); }
            } else { alert("User not found!"); }
        }

        async function loadMyGroups() {
            const res = await fetch(`${BASE_URL}/get-my-groups?email=${user.email.toLowerCase()}`);
            const data = await res.json();
            document.getElementById('active-list').innerHTML = data.joined.length 
                ? data.joined.map(g => `<div onclick="window.location.href='club-chat.html?id=${g.id}&name=${encodeURIComponent(g.group_name)}'" style="border:1px solid #4ecca3; padding:10px; margin:5px 0; cursor:pointer; border-radius:5px; background:rgba(78,204,163,0.1);">${g.group_name} üí¨</div>`).join('') 
                : "No clubs yet.";
        }

        async function securePurge() {
            if (confirm("Wipe everything?")) {
                await fetch(`${BASE_URL}/admin/reset-all-data`, { 
                    method: 'POST', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({adminPassword: "you must know what you're doing in order to delete everything."})
                });
                sessionStorage.clear(); window.location.href = 'index.html';
            }
        }

        function logout() { sessionStorage.clear(); window.location.href = 'index.html'; }
        init();
    </script>
</body>
</html>
